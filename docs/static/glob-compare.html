<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-10-03 Mon 23:23 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Glob v.s. OS Walk</title>
<meta name="author" content="Alberto Valdez" />
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="https://albertovaldez5.gitlab.io/org-template/resources/theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://albertovaldez5.gitlab.io/org-template/resources/theme/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://albertovaldez5.gitlab.io/org-template/resources/theme/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://albertovaldez5.gitlab.io/org-template/resources/theme/js/readtheorg.js"></script>
<link rel="shortcut icon" href="https://albertovaldez5.gitlab.io/org-template/resources/theme/favicon.ico">
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href=""> UP </a>
 |
 <a accesskey="H" href="../index.html"> HOME </a>
</div><div id="content" class="content">
<h1 class="title">Glob v.s. OS Walk
<br />
<span class="subtitle"><a href="https://github.com/AlbertoV5/python-blog">https://github.com/AlbertoV5/python-blog</a></span>
</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#glob-v-s-os-walk">1. Glob v.s. OS Walk</a>
<ul>
<li><a href="#mocks">1.1. Mocks</a></li>
<li><a href="#final-mock-function">1.2. Final mock function</a></li>
<li><a href="#profiler">1.3. Profiler</a></li>
<li><a href="#final-test-script">1.4. Final Test Script</a></li>
<li><a href="#results">1.5. Results</a></li>
<li><a href="#conclusion">1.6. Conclusion</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-glob-v-s-os-walk" class="outline-2">
<h2 id="glob-v-s-os-walk"><span class="section-number-2">1.</span> Glob v.s. OS Walk</h2>
<div class="outline-text-2" id="text-glob-v-s-os-walk">

<div id="org052eec9" class="figure">
<p><img src="../resources/nasa-CpHNKNRwXps-unsplash.jpg" alt="nasa-CpHNKNRwXps-unsplash.jpg" width="800px" />
</p>
</div>

<p>
This article is a follow-up to &ldquo;Glob generators in Python&rdquo;, we are going to compare the <code>os.walk</code><sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup> to the <code>Path.glob</code> method<sup><a id="fnr.2" class="footref" href="#fn.2" role="doc-backlink">2</a></sup> that we used in the past, both in the context of generators.
</p>

<p>
The question we are trying to answer is if we want to use <code>Path.glob</code> at all or if it is better to check for specific file extensions instead of using patterns.
</p>

<div class="src-name" id="orgc712c05">
<p>

</p>

</div>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ded492;">python</span> <span style="color: #e0e0e0;">--version</span>
</pre>
</div>

<pre class="example" id="org3c94a16">
Python 3.10.7
</pre>

<p>
We are going to use cProfile to measure the code execution and snakeviz <sup><a id="fnr.3" class="footref" href="#fn.3" role="doc-backlink">3</a></sup> to visualize the results. We are going to use a few other modules to help us build and evaluate the tests.
</p>

<div class="src-name" id="org215d687">
<p>
import-modules
</p>

</div>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #569CD6;">from</span><span style="color: #4EC9B0;"> pathlib </span><span style="color: #569CD6;">import</span><span style="color: #4EC9B0;"> </span><span style="color: #4EC9B0;">Path</span>
<span style="color: #569CD6;">from</span><span style="color: #4EC9B0;"> itertools </span><span style="color: #569CD6;">import</span><span style="color: #4EC9B0;"> permutations</span>
<span style="color: #569CD6;">import</span><span style="color: #4EC9B0;"> subprocess</span>
<span style="color: #569CD6;">import</span><span style="color: #4EC9B0;"> cProfile</span>
<span style="color: #569CD6;">import</span><span style="color: #4EC9B0;"> logging</span>
<span style="color: #569CD6;">import</span><span style="color: #4EC9B0;"> pstats</span>
<span style="color: #569CD6;">import</span><span style="color: #4EC9B0;"> shutil</span>
<span style="color: #569CD6;">import</span><span style="color: #4EC9B0;"> os</span>
</pre>
</div>
</div>

<div id="outline-container-mocks" class="outline-3">
<h3 id="mocks"><span class="section-number-3">1.1.</span> Mocks</h3>
<div class="outline-text-3" id="text-mocks">
<p>
We are going to construct a test case before writing the rest of the code. We will do so by creating a few directories and filling them with various file extensions.
</p>

<p>
In this scenario we will be searching for the file types: <code>csv</code>, <code>tsv</code> and <code>txt</code>. So we are going to add those extensions to a list that we will use to generate all possible permutations of the the extensions&rsquo; characters.
</p>

<p>
We are going to use <code>set</code> so we make sure we don&rsquo;t process extra data when doing the permutations and any further processing. However, we want to include extensions with repeated letters in the data we feed to the permutation function, so that data won&rsquo;t be converted to a set.
</p>

<div class="src-name" id="org2164768">
<p>
make-options
</p>

</div>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #569CD6;">def</span> <span style="color: #ded492;">create_options</span>(<span style="color: #9CDCFE;">extensions</span>):
    <span style="color: #9CDCFE;">data</span> <span style="color: #e0e0e0;">=</span> <span style="color: #C586C0;">list</span>(i <span style="color: #569CD6;">for</span> <span style="color: #9CDCFE;">e</span> <span style="color: #569CD6;">in</span> extensions <span style="color: #569CD6;">for</span> <span style="color: #9CDCFE;">i</span> <span style="color: #569CD6;">in</span> <span style="color: #C586C0;">list</span>(e))
    data.<span style="color: #ded492;">append</span>(<span style="color: #CE9178;">""</span>)
    <span style="color: #569CD6;">return</span> <span style="color: #C586C0;">list</span>(<span style="color: #C586C0;">set</span>(<span style="color: #CE9178;">""</span>.<span style="color: #ded492;">join</span>(c) <span style="color: #569CD6;">for</span> <span style="color: #9CDCFE;">c</span> <span style="color: #569CD6;">in</span> <span style="color: #ded492;">permutations</span>(data, <span style="color: #BBCCAA;">4</span>)))

</pre>
</div>

<p>
If we print our options, we can see that we have a large number of possible file prefixes we can use for testing.
</p>

<div class="src-name" id="orgc0507fb">
<p>
check-1
</p>

</div>
<div class="org-src-container">
<pre class="src src-python">

<span style="color: #9CDCFE;">options</span> <span style="color: #e0e0e0;">=</span> <span style="color: #ded492;">create_options</span>([<span style="color: #CE9178;">"csv"</span>, <span style="color: #CE9178;">"tsv"</span>, <span style="color: #CE9178;">"txt"</span>])
<span style="color: #C586C0;">print</span>(<span style="color: #C586C0;">len</span>(options))
</pre>
</div>

<pre class="example" id="org51ba8e5">
467
</pre>

<p>
Before creating the files in the test directory, we are going to add a few children directories so we can test recursive search too. We are going to create 2 &rsquo;tuneable&rsquo; variables, <code>depth</code> and <code>number</code>, which will effectively bring the total amount of directories to <code>depth ** number</code>. Then we are going to create the directories somewhat recursively while adding each one to a <code>directories</code> list.
</p>

<div class="src-name" id="org329abfb">
<p>
make-dirs
</p>

</div>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #569CD6;">def</span> <span style="color: #ded492;">create_directories</span>(<span style="color: #9CDCFE;">root</span>: <span style="color: #4EC9B0;">str</span>, <span style="color: #9CDCFE;">number</span>: <span style="color: #4EC9B0;">int</span>, <span style="color: #9CDCFE;">depth</span>: <span style="color: #4EC9B0;">int</span>):
    <span style="color: #9CDCFE;">root</span> <span style="color: #e0e0e0;">=</span> <span style="color: #4EC9B0;">Path</span>(root).<span style="color: #ded492;">resolve</span>()
    <span style="color: #569CD6;">if</span> root.<span style="color: #ded492;">is_dir</span>():
        shutil.<span style="color: #ded492;">rmtree</span>(root)
    <span style="color: #4EC9B0;">Path</span>.<span style="color: #ded492;">mkdir</span>(root, <span style="color: #9CDCFE;">parents</span><span style="color: #e0e0e0;">=</span><span style="color: #569CD6;">True</span>)
    <span style="color: #579C4C;"># func</span>
    <span style="color: #569CD6;">def</span> <span style="color: #ded492;">mk_dirs</span>(<span style="color: #9CDCFE;">parent</span>, <span style="color: #9CDCFE;">data</span>, <span style="color: #9CDCFE;">n</span>, <span style="color: #9CDCFE;">depth</span>):
        <span style="color: #569CD6;">if</span> depth <span style="color: #e0e0e0;">==</span> <span style="color: #BBCCAA;">0</span>:
            <span style="color: #569CD6;">return</span> <span style="color: #BBCCAA;">0</span>
        <span style="color: #569CD6;">for</span> <span style="color: #9CDCFE;">i</span> <span style="color: #569CD6;">in</span> <span style="color: #C586C0;">range</span>(n):
            <span style="color: #9CDCFE;">child</span> <span style="color: #e0e0e0;">=</span> parent <span style="color: #e0e0e0;">/</span> <span style="color: #CE9178;">f"</span><span style="color: #569CD6; background-color: #252525;">{</span><span style="color: #9CDCFE; background-color: #252525;">i</span><span style="color: #569CD6; background-color: #252525;">}</span><span style="color: #CE9178;">"</span>
            <span style="color: #4EC9B0;">Path</span>.<span style="color: #ded492;">mkdir</span>(child)
            data.<span style="color: #ded492;">append</span>(child)
            <span style="color: #ded492;">mk_dirs</span>(child, data, n, depth <span style="color: #e0e0e0;">-</span> <span style="color: #BBCCAA;">1</span>)

    <span style="color: #9CDCFE;">directories</span> <span style="color: #e0e0e0;">=</span> []
    <span style="color: #ded492;">mk_dirs</span>(root, directories, number, depth)
    directories.<span style="color: #ded492;">insert</span>(<span style="color: #BBCCAA;">0</span>, root)
    <span style="color: #569CD6;">return</span> directories

</pre>
</div>

<p>
Then we can separate the file extensions in different directories. We end up with <code>= directories if we count the root directory. So we are going to separate our {{{results(=467</code>)}}} into <code>x</code> files per directory.
</p>

<div class="src-name" id="orgc6ebe28">
<p>
check-2
</p>

</div>
<div class="org-src-container">
<pre class="src src-python">

<span style="color: #ded492;">create_directories</span>(<span style="color: #CE9178;">'../tests/extensions'</span>, <span style="color: #BBCCAA;">3</span>, <span style="color: #BBCCAA;">3</span>)
<span style="color: #C586C0;">print</span>(<span style="color: #C586C0;">len</span>(directories))
</pre>
</div>

<pre class="example" id="org2138661">

</pre>
</div>
</div>

<div id="outline-container-final-mock-function" class="outline-3">
<h3 id="final-mock-function"><span class="section-number-3">1.2.</span> Final mock function</h3>
<div class="outline-text-3" id="text-final-mock-function">
<p>
Finally, we create all the files spread across multiple directories and <code>assert</code> that there are at more files than the base <code>number</code> directories in each directory.
</p>

<div class="src-name" id="org355a5ed">
<p>
make-files
</p>

</div>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #569CD6;">def</span> <span style="color: #ded492;">test_makefiles</span>(<span style="color: #9CDCFE;">ext</span> <span style="color: #e0e0e0;">=</span> [<span style="color: #CE9178;">"csv"</span>, <span style="color: #CE9178;">"tsv"</span>, <span style="color: #CE9178;">"txt"</span>], <span style="color: #9CDCFE;">number</span> <span style="color: #e0e0e0;">=</span> <span style="color: #BBCCAA;">3</span>, <span style="color: #9CDCFE;">depth</span> <span style="color: #e0e0e0;">=</span> <span style="color: #BBCCAA;">3</span>):
    <span style="color: #9CDCFE;">options</span> <span style="color: #e0e0e0;">=</span> <span style="color: #ded492;">create_options</span>(ext)
    <span style="color: #9CDCFE;">directories</span> <span style="color: #e0e0e0;">=</span> <span style="color: #ded492;">create_directories</span>(<span style="color: #CE9178;">'../tests/extensions'</span>, number, depth)
    <span style="color: #9CDCFE;">n_opt</span> <span style="color: #e0e0e0;">=</span> <span style="color: #C586C0;">len</span>(options)
    <span style="color: #9CDCFE;">n_dir</span> <span style="color: #e0e0e0;">=</span> <span style="color: #C586C0;">len</span>(directories)
    <span style="color: #9CDCFE;">ratio</span> <span style="color: #e0e0e0;">=</span> <span style="color: #C586C0;">int</span>(n_opt<span style="color: #e0e0e0;">/</span>n_dir)
    <span style="color: #569CD6;">for</span> <span style="color: #9CDCFE;">i</span> <span style="color: #569CD6;">in</span> <span style="color: #C586C0;">range</span>(<span style="color: #BBCCAA;">0</span>, n_dir):
        <span style="color: #569CD6;">for</span> <span style="color: #9CDCFE;">j</span> <span style="color: #569CD6;">in</span> <span style="color: #C586C0;">range</span>(i <span style="color: #e0e0e0;">*</span> ratio, (i <span style="color: #e0e0e0;">*</span> ratio) <span style="color: #e0e0e0;">+</span> ratio):
            <span style="color: #9CDCFE;">filepath</span> <span style="color: #e0e0e0;">=</span> directories[i] <span style="color: #e0e0e0;">/</span> <span style="color: #CE9178;">f"file.</span><span style="color: #569CD6; background-color: #252525;">{</span><span style="color: #9CDCFE; background-color: #252525;">options[j]</span><span style="color: #569CD6; background-color: #252525;">}</span><span style="color: #CE9178;">"</span>
            subprocess.<span style="color: #ded492;">run</span>([<span style="color: #CE9178;">'touch'</span>, filepath])
        <span style="color: #569CD6;">assert</span> <span style="color: #C586C0;">len</span>(<span style="color: #C586C0;">list</span>(directories[i].<span style="color: #ded492;">glob</span>(<span style="color: #CE9178;">'*'</span>))) <span style="color: #e0e0e0;">&gt;</span> number
    <span style="color: #C586C0;">print</span>(<span style="color: #CE9178;">'All files were created.'</span>)

</pre>
</div>

<pre class="example" id="org3ad457f">
All files were created.
</pre>
</div>
</div>

<div id="outline-container-profiler" class="outline-3">
<h3 id="profiler"><span class="section-number-3">1.3.</span> Profiler</h3>
<div class="outline-text-3" id="text-profiler">
<p>
We will create a profiler wrapper function so we can apply it to whichever test function we want and get the profile data into a file with its name.
</p>

<div class="src-name" id="org7e8b3e9">
<p>
make-profiler
</p>

</div>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #569CD6;">def</span> <span style="color: #ded492;">profile</span>(<span style="color: #9CDCFE;">func</span>):
    <span style="color: #569CD6;">def</span> <span style="color: #ded492;">wrapper</span>(<span style="color: #e0e0e0;">*</span><span style="color: #9CDCFE;">args</span>, <span style="color: #e0e0e0;">**</span><span style="color: #9CDCFE;">kwargs</span>):
        <span style="color: #569CD6;">with</span> cProfile.<span style="color: #4EC9B0;">Profile</span>() <span style="color: #569CD6;">as</span> pr:
            <span style="color: #9CDCFE;">path</span> <span style="color: #e0e0e0;">=</span> <span style="color: #ded492;">func</span>(<span style="color: #e0e0e0;">*</span>args, <span style="color: #e0e0e0;">**</span>kwargs)
            <span style="color: #9CDCFE;">stats</span> <span style="color: #e0e0e0;">=</span> pstats.<span style="color: #4EC9B0;">Stats</span>(pr)
            stats.<span style="color: #ded492;">sort_stats</span>(pstats.<span style="color: #4EC9B0;">SortKey</span>.<span style="color: #e0e0e0;">TIME</span>)
            stats.<span style="color: #ded492;">dump_stats</span>(<span style="color: #9CDCFE;">filename</span><span style="color: #e0e0e0;">=</span><span style="color: #CE9178;">f"</span><span style="color: #569CD6; background-color: #252525;">{</span><span style="color: #9CDCFE; background-color: #252525;">path </span><span style="color: #e0e0e0; background-color: #252525;">/</span><span style="color: #9CDCFE; background-color: #252525;"> func.</span><span style="color: #9CDCFE; background-color: #252525;">__name__</span><span style="color: #569CD6; background-color: #252525;">}</span><span style="color: #CE9178;">.prof"</span>)

    <span style="color: #569CD6;">return</span> wrapper

</pre>
</div>
</div>
</div>

<div id="outline-container-final-test-script" class="outline-3">
<h3 id="final-test-script"><span class="section-number-3">1.4.</span> Final Test Script</h3>
<div class="outline-text-3" id="text-final-test-script">
<p>
We are going to combine all previous functions into a single script and include default values for running the test, which includes generating new extensions and directories. We are also gonna create a logger instance to display all info to the pytest stdout. Finally we are going to execute each function <code>n</code> number of times for better profiler results.
</p>

<div class="src-name" id="org6c3ab96">
<p>

</p>

</div>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #569CD6;">from</span><span style="color: #4EC9B0;"> pathlib </span><span style="color: #569CD6;">import</span><span style="color: #4EC9B0;"> </span><span style="color: #4EC9B0;">Path</span>
<span style="color: #569CD6;">from</span><span style="color: #4EC9B0;"> itertools </span><span style="color: #569CD6;">import</span><span style="color: #4EC9B0;"> permutations</span>
<span style="color: #569CD6;">import</span><span style="color: #4EC9B0;"> subprocess</span>
<span style="color: #569CD6;">import</span><span style="color: #4EC9B0;"> cProfile</span>
<span style="color: #569CD6;">import</span><span style="color: #4EC9B0;"> logging</span>
<span style="color: #569CD6;">import</span><span style="color: #4EC9B0;"> pstats</span>
<span style="color: #569CD6;">import</span><span style="color: #4EC9B0;"> shutil</span>
<span style="color: #569CD6;">import</span><span style="color: #4EC9B0;"> os</span>

<span style="color: #569CD6;">def</span> <span style="color: #ded492;">create_options</span>(<span style="color: #9CDCFE;">extensions</span>):
    <span style="color: #9CDCFE;">data</span> <span style="color: #e0e0e0;">=</span> <span style="color: #C586C0;">list</span>(i <span style="color: #569CD6;">for</span> <span style="color: #9CDCFE;">e</span> <span style="color: #569CD6;">in</span> extensions <span style="color: #569CD6;">for</span> <span style="color: #9CDCFE;">i</span> <span style="color: #569CD6;">in</span> <span style="color: #C586C0;">list</span>(e))
    data.<span style="color: #ded492;">append</span>(<span style="color: #CE9178;">""</span>)
    <span style="color: #569CD6;">return</span> <span style="color: #C586C0;">list</span>(<span style="color: #C586C0;">set</span>(<span style="color: #CE9178;">""</span>.<span style="color: #ded492;">join</span>(c) <span style="color: #569CD6;">for</span> <span style="color: #9CDCFE;">c</span> <span style="color: #569CD6;">in</span> <span style="color: #ded492;">permutations</span>(data, <span style="color: #BBCCAA;">4</span>)))

<span style="color: #569CD6;">def</span> <span style="color: #ded492;">create_directories</span>(<span style="color: #9CDCFE;">root</span>: <span style="color: #4EC9B0;">str</span>, <span style="color: #9CDCFE;">number</span>: <span style="color: #4EC9B0;">int</span>, <span style="color: #9CDCFE;">depth</span>: <span style="color: #4EC9B0;">int</span>):
    <span style="color: #9CDCFE;">root</span> <span style="color: #e0e0e0;">=</span> <span style="color: #4EC9B0;">Path</span>(root).<span style="color: #ded492;">resolve</span>()
    <span style="color: #569CD6;">if</span> root.<span style="color: #ded492;">is_dir</span>():
        shutil.<span style="color: #ded492;">rmtree</span>(root)
    <span style="color: #4EC9B0;">Path</span>.<span style="color: #ded492;">mkdir</span>(root, <span style="color: #9CDCFE;">parents</span><span style="color: #e0e0e0;">=</span><span style="color: #569CD6;">True</span>)
    <span style="color: #579C4C;"># func</span>
    <span style="color: #569CD6;">def</span> <span style="color: #ded492;">mk_dirs</span>(<span style="color: #9CDCFE;">parent</span>, <span style="color: #9CDCFE;">data</span>, <span style="color: #9CDCFE;">n</span>, <span style="color: #9CDCFE;">depth</span>):
        <span style="color: #569CD6;">if</span> depth <span style="color: #e0e0e0;">==</span> <span style="color: #BBCCAA;">0</span>:
            <span style="color: #569CD6;">return</span> <span style="color: #BBCCAA;">0</span>
        <span style="color: #569CD6;">for</span> <span style="color: #9CDCFE;">i</span> <span style="color: #569CD6;">in</span> <span style="color: #C586C0;">range</span>(n):
            <span style="color: #9CDCFE;">child</span> <span style="color: #e0e0e0;">=</span> parent <span style="color: #e0e0e0;">/</span> <span style="color: #CE9178;">f"</span><span style="color: #569CD6; background-color: #252525;">{</span><span style="color: #9CDCFE; background-color: #252525;">i</span><span style="color: #569CD6; background-color: #252525;">}</span><span style="color: #CE9178;">"</span>
            <span style="color: #4EC9B0;">Path</span>.<span style="color: #ded492;">mkdir</span>(child)
            data.<span style="color: #ded492;">append</span>(child)
            <span style="color: #ded492;">mk_dirs</span>(child, data, n, depth <span style="color: #e0e0e0;">-</span> <span style="color: #BBCCAA;">1</span>)

    <span style="color: #9CDCFE;">directories</span> <span style="color: #e0e0e0;">=</span> []
    <span style="color: #ded492;">mk_dirs</span>(root, directories, number, depth)
    directories.<span style="color: #ded492;">insert</span>(<span style="color: #BBCCAA;">0</span>, root)
    <span style="color: #569CD6;">return</span> directories

<span style="color: #569CD6;">def</span> <span style="color: #ded492;">test_makefiles</span>(<span style="color: #9CDCFE;">ext</span> <span style="color: #e0e0e0;">=</span> [<span style="color: #CE9178;">"csv"</span>, <span style="color: #CE9178;">"tsv"</span>, <span style="color: #CE9178;">"txt"</span>], <span style="color: #9CDCFE;">number</span> <span style="color: #e0e0e0;">=</span> <span style="color: #BBCCAA;">3</span>, <span style="color: #9CDCFE;">depth</span> <span style="color: #e0e0e0;">=</span> <span style="color: #BBCCAA;">3</span>):
    <span style="color: #9CDCFE;">options</span> <span style="color: #e0e0e0;">=</span> <span style="color: #ded492;">create_options</span>(ext)
    <span style="color: #9CDCFE;">directories</span> <span style="color: #e0e0e0;">=</span> <span style="color: #ded492;">create_directories</span>(<span style="color: #CE9178;">'../tests/extensions'</span>, number, depth)
    <span style="color: #9CDCFE;">n_opt</span> <span style="color: #e0e0e0;">=</span> <span style="color: #C586C0;">len</span>(options)
    <span style="color: #9CDCFE;">n_dir</span> <span style="color: #e0e0e0;">=</span> <span style="color: #C586C0;">len</span>(directories)
    <span style="color: #9CDCFE;">ratio</span> <span style="color: #e0e0e0;">=</span> <span style="color: #C586C0;">int</span>(n_opt<span style="color: #e0e0e0;">/</span>n_dir)
    <span style="color: #569CD6;">for</span> <span style="color: #9CDCFE;">i</span> <span style="color: #569CD6;">in</span> <span style="color: #C586C0;">range</span>(<span style="color: #BBCCAA;">0</span>, n_dir):
        <span style="color: #569CD6;">for</span> <span style="color: #9CDCFE;">j</span> <span style="color: #569CD6;">in</span> <span style="color: #C586C0;">range</span>(i <span style="color: #e0e0e0;">*</span> ratio, (i <span style="color: #e0e0e0;">*</span> ratio) <span style="color: #e0e0e0;">+</span> ratio):
            <span style="color: #9CDCFE;">filepath</span> <span style="color: #e0e0e0;">=</span> directories[i] <span style="color: #e0e0e0;">/</span> <span style="color: #CE9178;">f"file.</span><span style="color: #569CD6; background-color: #252525;">{</span><span style="color: #9CDCFE; background-color: #252525;">options[j]</span><span style="color: #569CD6; background-color: #252525;">}</span><span style="color: #CE9178;">"</span>
            subprocess.<span style="color: #ded492;">run</span>([<span style="color: #CE9178;">'touch'</span>, filepath])
        <span style="color: #569CD6;">assert</span> <span style="color: #C586C0;">len</span>(<span style="color: #C586C0;">list</span>(directories[i].<span style="color: #ded492;">glob</span>(<span style="color: #CE9178;">'*'</span>))) <span style="color: #e0e0e0;">&gt;</span> number
    <span style="color: #C586C0;">print</span>(<span style="color: #CE9178;">'All files were created.'</span>)

<span style="color: #569CD6;">def</span> <span style="color: #ded492;">profile</span>(<span style="color: #9CDCFE;">func</span>):
    <span style="color: #569CD6;">def</span> <span style="color: #ded492;">wrapper</span>(<span style="color: #e0e0e0;">*</span><span style="color: #9CDCFE;">args</span>, <span style="color: #e0e0e0;">**</span><span style="color: #9CDCFE;">kwargs</span>):
        <span style="color: #569CD6;">with</span> cProfile.<span style="color: #4EC9B0;">Profile</span>() <span style="color: #569CD6;">as</span> pr:
            <span style="color: #9CDCFE;">path</span> <span style="color: #e0e0e0;">=</span> <span style="color: #ded492;">func</span>(<span style="color: #e0e0e0;">*</span>args, <span style="color: #e0e0e0;">**</span>kwargs)
            <span style="color: #9CDCFE;">stats</span> <span style="color: #e0e0e0;">=</span> pstats.<span style="color: #4EC9B0;">Stats</span>(pr)
            stats.<span style="color: #ded492;">sort_stats</span>(pstats.<span style="color: #4EC9B0;">SortKey</span>.<span style="color: #e0e0e0;">TIME</span>)
            stats.<span style="color: #ded492;">dump_stats</span>(<span style="color: #9CDCFE;">filename</span><span style="color: #e0e0e0;">=</span><span style="color: #CE9178;">f"</span><span style="color: #569CD6; background-color: #252525;">{</span><span style="color: #9CDCFE; background-color: #252525;">path </span><span style="color: #e0e0e0; background-color: #252525;">/</span><span style="color: #9CDCFE; background-color: #252525;"> func.</span><span style="color: #9CDCFE; background-color: #252525;">__name__</span><span style="color: #569CD6; background-color: #252525;">}</span><span style="color: #CE9178;">.prof"</span>)

    <span style="color: #569CD6;">return</span> wrapper


<span style="color: #ded492;">@profile</span>
<span style="color: #569CD6;">def</span> <span style="color: #ded492;">test_main</span>():
    <span style="color: #9CDCFE;">log</span> <span style="color: #e0e0e0;">=</span> logging.<span style="color: #ded492;">getLogger</span>(<span style="color: #9CDCFE;">__name__</span>)
    log.<span style="color: #ded492;">setLevel</span>(logging.<span style="color: #e0e0e0;">DEBUG</span>)
    <span style="color: #9CDCFE;">ext</span> <span style="color: #e0e0e0;">=</span> [<span style="color: #CE9178;">'csv'</span>, <span style="color: #CE9178;">'tsv'</span>, <span style="color: #CE9178;">'txt'</span>]
    <span style="color: #9CDCFE;">pattern</span> <span style="color: #e0e0e0;">=</span> <span style="color: #CE9178;">'**/*.[ct][sx][vt$]'</span>
    <span style="color: #9CDCFE;">rootd</span> <span style="color: #e0e0e0;">=</span> <span style="color: #CE9178;">'../tests/extensions'</span>
    <span style="color: #9CDCFE;">outcome</span> <span style="color: #e0e0e0;">=</span> {<span style="color: #CE9178;">"glob"</span>:[], <span style="color: #CE9178;">"os"</span>:[]}

    <span style="color: #579C4C;"># using glob</span>
    <span style="color: #569CD6;">def</span> <span style="color: #ded492;">use_glob</span>():
        <span style="color: #569CD6;">for</span> <span style="color: #9CDCFE;">f</span> <span style="color: #569CD6;">in</span> <span style="color: #4EC9B0;">Path</span>(rootd).<span style="color: #ded492;">glob</span>(pattern):
            <span style="color: #569CD6;">yield</span> f

    <span style="color: #569CD6;">def</span> <span style="color: #ded492;">consume_glob</span>():
        outcome[<span style="color: #9CDCFE;">"glob"</span>] <span style="color: #e0e0e0;">=</span> <span style="color: #C586C0;">list</span>(<span style="color: #4EC9B0;">Path</span>(rootd).<span style="color: #ded492;">glob</span>(pattern))

    <span style="color: #579C4C;"># using os</span>
    <span style="color: #569CD6;">def</span> <span style="color: #ded492;">use_os_comp</span>():
        outcome[<span style="color: #9CDCFE;">"os"</span>] <span style="color: #e0e0e0;">=</span> [
            f
            <span style="color: #569CD6;">for</span> <span style="color: #9CDCFE;">root</span>, <span style="color: #9CDCFE;">dirs</span>, <span style="color: #9CDCFE;">files</span> <span style="color: #569CD6;">in</span> os.<span style="color: #ded492;">walk</span>(rootd)
            <span style="color: #569CD6;">for</span> <span style="color: #9CDCFE;">f</span> <span style="color: #569CD6;">in</span> files <span style="color: #569CD6;">if</span> f.<span style="color: #ded492;">split</span>(<span style="color: #CE9178;">'.'</span>)[<span style="color: #BBCCAA;">1</span>] <span style="color: #569CD6;">in</span> ext
        ]

    <span style="color: #569CD6;">def</span> <span style="color: #ded492;">use_os</span>():
        <span style="color: #569CD6;">for</span> <span style="color: #9CDCFE;">root</span>, <span style="color: #9CDCFE;">dirs</span>, <span style="color: #9CDCFE;">files</span> <span style="color: #569CD6;">in</span> os.<span style="color: #ded492;">walk</span>(rootd):
            <span style="color: #9CDCFE;">path</span> <span style="color: #e0e0e0;">=</span> root.<span style="color: #ded492;">split</span>(os.<span style="color: #9CDCFE;">sep</span>)
            <span style="color: #569CD6;">for</span> <span style="color: #9CDCFE;">file</span> <span style="color: #569CD6;">in</span> files:
                <span style="color: #569CD6;">if</span> file.<span style="color: #ded492;">split</span>(<span style="color: #CE9178;">"."</span>)[<span style="color: #BBCCAA;">1</span>] <span style="color: #569CD6;">in</span> ext:
                    outcome[<span style="color: #CE9178;">"os"</span>].<span style="color: #ded492;">append</span>(file)

    <span style="color: #569CD6;">def</span> <span style="color: #ded492;">use_os_gen</span>():
        <span style="color: #569CD6;">for</span> <span style="color: #9CDCFE;">root</span>, <span style="color: #9CDCFE;">dirs</span>, <span style="color: #9CDCFE;">files</span> <span style="color: #569CD6;">in</span> os.<span style="color: #ded492;">walk</span>(rootd):
            <span style="color: #569CD6;">for</span> <span style="color: #9CDCFE;">file</span> <span style="color: #569CD6;">in</span> files:
                <span style="color: #569CD6;">if</span> file.<span style="color: #ded492;">split</span>(<span style="color: #CE9178;">"."</span>)[<span style="color: #BBCCAA;">1</span>] <span style="color: #569CD6;">in</span> ext:
                    <span style="color: #569CD6;">yield</span> file
    <span style="color: #579C4C;"># process</span>
    <span style="color: #9CDCFE;">times</span> <span style="color: #e0e0e0;">=</span> <span style="color: #BBCCAA;">100</span>
    [<span style="color: #ded492;">use_glob</span>() <span style="color: #569CD6;">for</span> <span style="color: #9CDCFE;">i</span> <span style="color: #569CD6;">in</span> <span style="color: #C586C0;">range</span>(times)]
    [<span style="color: #ded492;">consume_glob</span>() <span style="color: #569CD6;">for</span> <span style="color: #9CDCFE;">i</span> <span style="color: #569CD6;">in</span> <span style="color: #C586C0;">range</span>(times)]
    [<span style="color: #ded492;">use_os</span>() <span style="color: #569CD6;">for</span> <span style="color: #9CDCFE;">i</span> <span style="color: #569CD6;">in</span> <span style="color: #C586C0;">range</span>(times)]
    [<span style="color: #ded492;">use_os_comp</span>() <span style="color: #569CD6;">for</span> <span style="color: #9CDCFE;">i</span> <span style="color: #569CD6;">in</span> <span style="color: #C586C0;">range</span>(times)]
    [<span style="color: #ded492;">use_os_gen</span>() <span style="color: #569CD6;">for</span> <span style="color: #9CDCFE;">i</span> <span style="color: #569CD6;">in</span> <span style="color: #C586C0;">range</span>(times)]

    <span style="color: #569CD6;">def</span> <span style="color: #ded492;">consume_gen</span>(<span style="color: #9CDCFE;">gen</span>):
        <span style="color: #569CD6;">for</span> <span style="color: #9CDCFE;">file</span> <span style="color: #569CD6;">in</span> gen:
            <span style="color: #579C4C;"># if file.replace("file.", "") == "csv":</span>
                <span style="color: #579C4C;"># break</span>
            <span style="color: #569CD6;">if</span> file.<span style="color: #9CDCFE;">suffix</span> <span style="color: #e0e0e0;">==</span> <span style="color: #CE9178;">".csv"</span>:
                <span style="color: #569CD6;">break</span>

    [<span style="color: #ded492;">consume_gen</span>(<span style="color: #ded492;">use_glob</span>()) <span style="color: #569CD6;">for</span> <span style="color: #9CDCFE;">i</span> <span style="color: #569CD6;">in</span> <span style="color: #C586C0;">range</span>(times)]
    log.<span style="color: #ded492;">debug</span>(outcome)
    <span style="color: #569CD6;">return</span> <span style="color: #4EC9B0;">Path</span>(<span style="color: #CE9178;">'tests/prof'</span>)

<span style="color: #569CD6;">if</span> <span style="color: #9CDCFE;">__name__</span> <span style="color: #e0e0e0;">==</span> <span style="color: #CE9178;">"__main__"</span>:
    <span style="color: #9CDCFE;">ext</span> <span style="color: #e0e0e0;">=</span> [<span style="color: #CE9178;">'csv'</span>, <span style="color: #CE9178;">'tsv'</span>, <span style="color: #CE9178;">'txt'</span>, <span style="color: #CE9178;">'xlsx'</span>, <span style="color: #CE9178;">'jpg'</span>, <span style="color: #CE9178;">'png'</span>]
    <span style="color: #ded492;">test_makefiles</span>(ext, <span style="color: #BBCCAA;">5</span>, <span style="color: #BBCCAA;">5</span>)
    <span style="color: #ded492;">test_main</span>()
</pre>
</div>
</div>
</div>

<div id="outline-container-results" class="outline-3">
<h3 id="results"><span class="section-number-3">1.5.</span> Results</h3>
<div class="outline-text-3" id="text-results">
<p>
We&rsquo;ll run the test with <code>pytest</code>.
</p>

<div class="src-name" id="orgd80cd5d">
<p>

</p>

</div>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ded492;">pytest</span> <span style="color: #9CDCFE;">--log-cli-level=10</span>
</pre>
</div>

<pre class="example" id="org7bf8093">
============================= test session starts ==============================
platform darwin -- Python 3.10.7, pytest-7.1.3, pluggy-1.0.0
rootdir: /Users/albertovaldez/python-blog
plugins: profiling-1.7.0
collected 2 items

tests/glob/test_main.py::test_makefiles PASSED                           [ 50%]
tests/glob/test_main.py::test_main
-------------------------------- live log call ---------------------------------
DEBUG    test_main:test_main.py:113 {'glob': [PosixPath('../tests/extensions/0/1/1/file.txv'), PosixPath('../tests/extensions/1/1/2/file.cxt'), PosixPath('../tests/extensions/1/2/file.tsv'), PosixPath('../tests/extensions/2/0/0/file.csv'), PosixPath('../tests/extensions/2/0/1/file.cst'), PosixPath('../tests/extensions/2/0/1/file.tst'), PosixPath('../tests/extensions/2/1/file.cxv')], 'os': ['file.tsv', 'file.csv']}
PASSED                                                                   [100%]

============================== 2 passed in 2.56s ===============================
</pre>

<p>
The first result that we can see from the command line log is that the pattern will find files that overlap with the extensions we are looking for. For example: <code>txv</code>, <code>cxt</code> and <code>tst</code>. This may be enough downside for not considering using only glob patterns.
</p>

<p>
Then we are going to read the profiler output with <code>snakeviz</code>.
</p>
<div class="src-name" id="orga27769e">
<p>

</p>

</div>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ded492;">pip</span> install snakeviz
</pre>
</div>

<div class="src-name" id="org34ca888">
<p>

</p>

</div>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ded492;">snakeviz</span> tests/prof/test_main.prof
</pre>
</div>

<p>
The first time we ran the test we compared the execution time of the following functions.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">function</th>
<th scope="col" class="org-right">ttime (s)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">consume_glob</td>
<td class="org-right">0.378</td>
</tr>

<tr>
<td class="org-left">use_os</td>
<td class="org-right">0.248</td>
</tr>

<tr>
<td class="org-left">use_os_comp</td>
<td class="org-right">0.244</td>
</tr>
</tbody>
</table>



<div id="org39d4e97" class="figure">
<p><img src="../resources/profiler/glob-0.png" alt="glob-0.png" width="700px" />
</p>
</div>

<p>
The <code>os.walk</code> method is faster and more accurate as we get the exact file extensions we are looking for.
</p>

<p>
However, if we stop the generator from the <code>glob</code> method once a condition is met, we get a shorter execution time, as well as lesser memory usage.
</p>


<div id="orga755110" class="figure">
<p><img src="../resources/profiler/glob-1.png" alt="glob-1.png" width="700px" />
</p>
</div>

<p>
When using <code>os.walk</code> as a generator we get a slightly slower execution time when following the previous procedure. This may just be because of how <code>os.walk</code> traverses the tree or because we are making a few additional checks when validating file extension.
</p>


<div id="orgabd1ce7" class="figure">
<p><img src="../resources/profiler/glob-2.png" alt="glob-2.png" width="700px" />
</p>
</div>
</div>
</div>

<div id="outline-container-conclusion" class="outline-3">
<h3 id="conclusion"><span class="section-number-3">1.6.</span> Conclusion</h3>
<div class="outline-text-3" id="text-conclusion">
<p>
Generators win any argument no matter what. The results from <code>glob</code> weren&rsquo;t favorable as we had too many collateral file extension, mainly because of how our test was setup. This is not enough accuracy for us to support using glob patterns so making our own generator from <code>os.walk</code> may be the best option. We can always combine both modules for better filepath information and object-oriented features.
</p>

<div class="src-name" id="orga7064ee">
<p>

</p>

</div>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #569CD6;">def</span> <span style="color: #ded492;">walk_gen</span>(<span style="color: #9CDCFE;">path</span>, <span style="color: #9CDCFE;">extensions</span>):
    <span style="color: #569CD6;">for</span> <span style="color: #9CDCFE;">root</span>, <span style="color: #9CDCFE;">dirs</span>, <span style="color: #9CDCFE;">files</span> <span style="color: #569CD6;">in</span> os.<span style="color: #ded492;">walk</span>(path):
        <span style="color: #569CD6;">for</span> <span style="color: #9CDCFE;">file</span> <span style="color: #569CD6;">in</span> files:
            <span style="color: #569CD6;">if</span> file.<span style="color: #ded492;">split</span>(<span style="color: #CE9178;">"."</span>)[<span style="color: #BBCCAA;">1</span>] <span style="color: #569CD6;">in</span> extensions:
                <span style="color: #569CD6;">yield</span> <span style="color: #4EC9B0;">Path</span>(root) <span style="color: #e0e0e0;">/</span> file

<span style="color: #569CD6;">for</span> <span style="color: #9CDCFE;">f</span> <span style="color: #569CD6;">in</span> <span style="color: #ded492;">walk_gen</span>(<span style="color: #CE9178;">"../tests"</span>, [<span style="color: #CE9178;">"py"</span>, <span style="color: #CE9178;">"prof"</span>]):
    <span style="color: #C586C0;">print</span>(f)
</pre>
</div>

<pre class="example" id="orgd903934">
../tests/prof/test_main.prof
../tests/glob/test_main.py
</pre>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
<a href="https://docs.python.org/3/library/os.html#os.walk">https://docs.python.org/3/library/os.html#os.walk</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2" role="doc-backlink">2</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
<a href="https://docs.python.org/3/library/pathlib.html#pathlib.Path.glob">https://docs.python.org/3/library/pathlib.html#pathlib.Path.glob</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.3" class="footnum" href="#fnr.3" role="doc-backlink">3</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
<a href="https://jiffyclub.github.io/snakeviz/">https://jiffyclub.github.io/snakeviz/</a>
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<p class="author">Author: Alberto Valdez</p>
<p class="date">Created: 2022-10-03 Mon 23:23</p>
</div>
</body>
</html>
